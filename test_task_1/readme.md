**Тестовое задание от компании X**

У вас есть доступ к базе данных Отдела продаж (PostgreSQL), куда загружаются данные об ответах менеджеров в сделках в **CRM**.
Диалог с каждым клиентом ведётся внутри своей сделки.

Необходимо:

1. Написать SQL-запрос, который будет рассчитывать среднее время ответа для каждого менеджера/пары менеджеров.

Расчёт должен учитывать следующее:

• если в диалоге идут несколько сообщений подряд от клиента или менеджера, то при расчёте времени ответа надо учитывать только первое сообщение из каждого блока;

• менеджеры работают с 09:30 до 00:00, поэтому нерабочее время не должно учитываться в расчёте среднего времени ответа, т.е. если клиент написал в 23:59, а менеджер ответил в 09:30 – время ответа равно одной минуте;

• ответы на сообщения, пришедшие ночью также нужно учитывать.

**Описание таблиц**

Доступные таблицы:

• test.chat_messages
• test.managers
• test.rops

**test.chat_messages**

Здесь хранятся данные о входящих и исходящих сообщениях внутри сделок.

|            |          |                                                                                                                                                                   |
| ---------- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Поле       | Тип поля | Описание поля                                                                                                                                                     |
| message_id | varchar  | Уникальный идентификатор сообщения                                                                                                                                |
| type       | varchar  | Тип сообщения:<br><br>_outgoing_chat_message_ – исходящее сообщение от менеджера клиенту<br><br>_incoming_chat_message_ – входящее сообщение от клиента менеджеру |
| entity_id  | int      | Идентификатор сделки в amoCRM. На каждого клиента открывается отдельная сделка                                                                                    |
| created_by | int      | Идентификатор того, кто написал сообщение. У клиентов всегда 0.<br><br>Список соответствия идентификаторов менеджеров и их имён находится в таблице test.managers |
| created_at | int      | Время создания сообщения в формате Unix Timestamp                                                                                                                 |

**test.managers**

Здесь хранятся данные о менеджерах

|          |          |                                                                                     |
| -------- | -------- | ----------------------------------------------------------------------------------- |
| Поле     | Тип поля | Описание поля                                                                       |
| mop_id   | int      | Уникальный идентификатор менеджера                                                  |
| name_mop | varchar  | Имя менеджера/пары менеджеров                                                       |
| rop_id   | varchar  | Уникальный идентификатор руководителя отдела продаж, в чём отделе работает менеджер |

**test.rops**

Здесь хранятся данные о руководителях Отдела продаж

|          |          |                                                     |
| -------- | -------- | --------------------------------------------------- |
| Поле     | Тип поля | Описание поля                                       |
| rop_id   | int      | Уникальный идентификатор руководителя отдела продаж |
| rop_name | varchar  | Имя руководителя отдела продаж                      |

**Результат выполнения задания**

В качестве результата выполнения задания необходимо предоставить:

1. SQL-запрос для расчёта среднего времени ответа менеджеров с подробными комментариями, что и как делали.

**Мой ответ на тестовое задние:**

```sql
WITH pre1 AS (
    -- Выбираем уникальные записи по паре (answer_created_by, aswer_tm)
    SELECT DISTINCT ON (answer_created_by, aswer_tm)
        icm.entity_id, -- ID сделки
        icm.created_by, -- ID клиента, отправившего входящее сообщение
        to_timestamp(icm.created_at) AS asc_tm, -- Время создания входящего сообщения (преобразованное в timestamp)
        cm.aswer_tm, -- Время ответа на входящее сообщение
        cm.answer_created_by -- ID менеджера, отправившего ответ
    FROM test.chat_messages AS icm -- Основная таблица с сообщениями
    LEFT JOIN LATERAL (
        -- Подзапрос для поиска ближайшего ответа на входящее сообщение
        SELECT
            to_timestamp(created_at) AS aswer_tm, -- Время ответа (преобразованное в timestamp)
            created_by AS answer_created_by -- ID пользователя, отправившего ответ
        FROM test.chat_messages
        WHERE
            entity_id = icm.entity_id -- Ответ должен быть в той же сделке
            AND created_by != icm.created_by -- Ответ должен быть от менеджера
            AND created_at > icm.created_at -- Ответ должен быть отправлен после входящего сообщения
            AND type = 'outgoing_chat_message' -- Тип сообщения — 'outgoing_chat_message' (ответ)
        LIMIT 1 -- Ограничиваем результат одним ответом (ближайшим по времени)
    ) AS cm ON true
    WHERE icm.type = 'incoming_chat_message' -- выбираем только 'incoming_chat_message' сообщения
),
-- Создаем временную таблицу pre2, которая рассчитывает временной интервал между входящим сообщением и ответом
pre2 AS (
    SELECT
        answer_created_by, -- ID менеджера, отправившего ответ
        justify_interval(
            CASE
                -- Если и входящее сообщение, и ответ были отправлены между 00:00 и 09:30, считаем разницу напрямую
                WHEN asc_tm::time BETWEEN '00:00:00' AND '09:30:00' AND aswer_tm::time BETWEEN '00:00:00' AND '09:30:00' THEN aswer_tm - asc_tm
                -- Если входящее сообщение было отправлено между 00:00 и 09:30, а ответ — позже, вычитаем время до 09:30
                WHEN asc_tm::time BETWEEN '00:00:00' AND '09:30:00' THEN aswer_tm - (date_trunc('day', asc_tm) + INTERVAL '09:30')
                -- Если ответ был отправлен между 00:00 и 09:30, а входящее сообщение — раньше, считаем разницу напрямую
                WHEN aswer_tm::time BETWEEN '00:00:00' AND '09:30:00' THEN aswer_tm - asc_tm
                -- В остальных случаях вычитаем 9 часов 30 минут за каждый день между входящим сообщением и ответом
                ELSE aswer_tm - asc_tm - (INTERVAL '9 hour 30 MINUTE' * (DATE(aswer_tm) - DATE(asc_tm)))
            END
        ) AS diff_time -- Временной интервал между входящим сообщением и ответом
    FROM pre1
    WHERE aswer_tm IS NOT NULL -- выбираем записи, где есть ответ от менеджера
)
-- Финальный запрос: вычисляем среднее время ответа для каждого менеджера и отдела
SELECT
    to_char(AVG(pre2.diff_time), 'HH24:MI:SS') AS "Среднее время ответа", -- Среднее время ответа
    m.name_mop Менеджер, -- Имя менеджера
    r.rop_name AS "Руководитель Отдела" -- Имя руководителя отдела
FROM pre2
LEFT JOIN test.managers AS m ON m.mop_id = pre2.answer_created_by -- Присоединяем таблицу менеджеров
LEFT JOIN test.rops AS r ON m.rop_id::int = r.rop_id -- Присоединяем таблицу с руководителями отделов
GROUP BY m.name_mop, r.rop_name -- Группируем по менеджеру и руководителю
```

### Результат запроса:

```
Среднее время ответа|Менеджер        |Руководитель Отдела|
--------------------+----------------+-------------------+
00:13:06            |Алина и Юля     |Эля РОП            |
00:23:33            |Аня и Ксюша     |Катя РОП           |
00:24:33            |Вика и Катя     |Катя РОП           |
00:09:05            |Влада и Настя   |Эля РОП            |
00:22:26            |Гюнель и Илина  |Катя РОП           |
00:31:28            |Даша и Влада    |Полина РОП         |
00:08:08            |Даша и Даша     |Полина РОП         |
00:13:49            |Даша и Карина   |Эля РОП            |
00:37:40            |Ира и Варя      |Катя РОП           |
00:14:40            |Ками и Мила     |Эля РОП            |
00:21:54            |Ксюша и Джамиля |Катя РОП           |
00:14:21            |Лиза и Ева      |Полина РОП         |
00:15:35            |Мария и Соня    |Полина РОП         |
00:10:15            |Настя и Даша    |Катя РОП           |
00:17:44            |Настя и Малика  |Эля РОП            |
00:16:17            |Настя и Саша    |Полина РОП         |
00:18:43            |Полина Мирзоян  |Эля РОП            |
00:29:06            |Порхачева Полина|Эля РОП            |
00:25:59            |Соня и Катя     |Полина РОП         |
00:18:43            |Софья Боднар    |Эля РОП            |
00:21:51            |Юля и Наташа    |Катя РОП           |
```

Проверить запрос

```
docker compose up
```

Тестовые таблицы с данными создадуться автоматически при первом запуске.
